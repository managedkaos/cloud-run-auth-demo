{% extends "base.html" %}

{% block title %}Login{% endblock %}

{% block content %}
<div class="login-page">
    <div class="card login-card">
        <h2 class="text-center">Welcome Back</h2>
        <form id="login-form">
            <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" placeholder="you@example.com" required>
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="••••••••" required>
            </div>
            <button type="submit" class="btn">Sign In</button>
        </form>
        <p class="mt-4 text-center text-sm" style="color: var(--text-secondary);">
            Don't have an account? Contact admin.
        </p>
    </div>
</div>

<script type="module">
    // Import Firebase SDK (CDN)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";

    // TODO: REPLACE THIS WITH YOUR FIREBASE CONFIG FROM CONSOLE
    // Go to Firebase Console > Project Settings > General > Your Apps > SDK Setup and Configuration
    //const firebaseConfig = {
    //    apiKey: "YOUR_API_KEY",
    //    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    //    projectId: "YOUR_PROJECT_ID",
    //    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    //    messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
    //    appId: "YOUR_APP_ID"
    //};

    const firebaseConfig = {
        apiKey: "AIzaSyBQB2Cu1_zWExoECU2OV0w-8BJ3H-bpM24",
        authDomain: "cloud-run-and-firebase.firebaseapp.com",
        projectId: "cloud-run-and-firebase",
        storageBucket: "cloud-run-and-firebase.firebasestorage.app",
        messagingSenderId: "662380295235",
        appId: "1:662380295235:web:f277cfa6e0a9e352bf90f6",
        measurementId: "G-ENKEMEB2TF"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    document.getElementById('login-form').onsubmit = async (e) => {
        e.preventDefault();
        const btn = e.target.querySelector('button');
        const originalText = btn.innerText;
        btn.innerText = 'Signing in...';
        btn.disabled = true;

        try {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            const idToken = await userCredential.user.getIdToken();

            // Send token to FastAPI to set a secure HTTP-only cookie
            const response = await fetch('/auth/session', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: idToken })
            });

            if (response.ok) {
                window.location.href = '/dashboard';
            } else {
                alert('Failed to create session');
                btn.innerText = originalText;
                btn.disabled = false;
            }
        } catch (error) {
            console.error(error);
            alert('Login failed: ' + error.message);
            btn.innerText = originalText;
            btn.disabled = false;
        }
    };
</script>
{% endblock %}
